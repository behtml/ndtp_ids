# Веб-интерфейс NDTP IDS

## Обзор

Веб-интерфейс предоставляет удобный способ мониторинга и управления системой обнаружения вторжений NDTP IDS. Он объединяет:

1. **Визуализацию данных** - дашборд с основной статистикой
2. **Интеграцию Suricata правил** - гибридная система детекции
3. **Адаптивное обучение** - автоматическая настройка базовых линий
4. **Поведенческий анализ** - обнаружение аномалий на основе z-score

## Преимущества над Suricata

Согласно документу "Проекты ндтп", система предлагает следующие улучшения:

### 1. Объяснимость (Explainable Security)
- Показывает не только факт аномалии, но и причину
- Указывает конкретные метрики и их значения
- Предоставляет контекст для принятия решений

### 2. Адаптивность
- Автоматическое обучение на базовом поведении сети
- Динамическая подстройка порогов через EWMA
- Учет изменений во времени (день/ночь, будни/выходные)

### 3. Поведенческий анализ
- Работает даже с зашифрованным трафиком (анализ метаданных)
- Обнаруживает новые угрозы (zero-day)
- Профилирование хостов по ролям

### 4. Защита самой системы
- Защита от обучения на аномалиях
- Целостность логов
- Безопасная модель реагирования

## Установка

### Требования

```bash
pip install -r requirements.txt
```

Требуемые пакеты:
- `scapy>=2.5.0` - захват пакетов
- `flask>=3.0.0` - веб-интерфейс
- `numpy>=1.24.0` - численные вычисления (ML)
- `scikit-learn>=1.3.0` - Isolation Forest (ML)

### Быстрый старт

```bash
# Запуск веб-интерфейса
python -m ndtp_ids.web_interface --host 0.0.0.0 --port 5000

# С указанием пути к базе данных
python -m ndtp_ids.web_interface --db /path/to/ids.db --port 8080
```

## Архитектура

```
┌─────────────────┐
│  Packet         │
│  Collector      │ ← Захват трафика
└────────┬────────┘
         │
         ├──────────────┐
         │              v
         │         ┌─────────────────┐
         │         │  Suricata       │ ← Проверка правил (сигнатурный анализ)
         │         │  Rules Engine   │
         │         └────────┬────────┘
         v                  │
┌─────────────────┐         │
│  Aggregator     │ ← Агрегация метрик
└────────┬────────┘         │
         │                  │
         v                  │
┌─────────────────┐         │
│  Adaptive       │ ← Обучение и профилирование
│  Trainer        │
└────────┬────────┘         │
         │                  │
         ├──────────┐       │
         v          v       │
┌──────────┐ ┌──────────┐  │
│ Z-Score  │ │ ML (IF)  │  │
│ Detector │ │ Detector │  │
└────┬─────┘ └────┬─────┘  │
     │            │         │
     v            v         v
┌────────────────────────────┐
│  Hybrid Scorer             │ ← Три слоя детекции
│  (weighted combination)    │
└────────────┬───────────────┘
             │
             v
┌─────────────────┐
│  Web            │ ← Визуализация и управление
│  Interface      │
└─────────────────┘
```

## Компоненты системы

### 1. Suricata Rules Parser (`suricata_rules.py`)

Парсер и движок для правил Suricata.

**Возможности:**
- Парсинг правил в формате Suricata
- Сопоставление пакетов с правилами
- Поддержка базовых операторов (any, CIDR, диапазоны портов)

**Пример использования:**

```python
from ndtp_ids.suricata_rules import SuricataRuleParser

parser = SuricataRuleParser()
parser.load_rules_from_file("rules.rules")

# Проверка пакета
packet_event = {
    'src_ip': '192.168.1.100',
    'dst_ip': '8.8.8.8',
    'dst_port': 22,
    'protocol': 'TCP'
}

matches = parser.match_packet(packet_event)
for rule, reason in matches:
    print(f"Alert: {reason}")
```

### 2. Adaptive Trainer (`adaptive_trainer.py`)

Модуль для адаптивного обучения и профилирования хостов.

**Ключевые функции:**

#### Режим обучения
- Автоматический сбор baseline (первые N наблюдений)
- Переход в режим детекции при достаточном количестве данных

#### EWMA (Exponential Weighted Moving Average)
```python
mean_new = α × current + (1-α) × mean_old
```
- Плавная адаптация к изменениям
- Коэффициент α = 0.05-0.2

#### Скользящее окно
- Пересчет статистик по последним N наблюдениям
- Учет изменений во времени

#### Защита от обучения на аномалиях
- Аномальные наблюдения не включаются в baseline
- Предотвращение "отравления" модели

**Пример использования:**

```python
from ndtp_ids.adaptive_trainer import AdaptiveTrainer

trainer = AdaptiveTrainer(
    learning_window=100,    # 100 наблюдений для обучения
    ewma_alpha=0.1,         # Коэффициент сглаживания
    sliding_window_size=50  # Размер скользящего окна
)

# Добавление наблюдения
metrics = {
    'connections_count': 15,
    'unique_ports': 3,
    'unique_dst_ips': 2,
    'total_bytes': 5000,
    'avg_packet_size': 500
}
trainer.add_metrics_sample('192.168.1.100', metrics, is_anomaly=False)

# Получение профиля
profile = trainer.get_host_profile('192.168.1.100')
print(f"Режим обучения: {profile.is_learning}")
print(f"Наблюдений: {profile.samples_count}")
```

### 3. Web Interface (`web_interface.py`)

Flask-приложение для визуализации и управления.

**Страницы:**
- `/` - Dashboard с общей статистикой
- `/monitoring` - Мониторинг в реальном времени
- `/hosts` - Список отслеживаемых хостов
- `/alerts` - История алертов
- `/rules` - Правила Suricata
- `/training` - Управление режимом обучения
- `/hybrid` - Гибридный анализ (три слоя детекции)

**API endpoints:**
- `GET /api/stats` - Общая статистика
- `GET /api/alerts` - Список алертов
- `GET /api/hosts` - Список хостов
- `GET /api/host/<ip>` - Детали хоста
- `POST /api/host/<ip>/learning` - Установка режима обучения
- `POST /api/host/<ip>/reset` - Сброс профиля
- `GET /api/suricata/rules` - Список правил
- `POST /api/suricata/rules` - Добавление правила

## Полный рабочий процесс

### 1. Запуск системы

```bash
# Терминал 1: Коллектор + Агрегатор
python -m ndtp_ids.packet_collector | python -m ndtp_ids.aggregator

# Терминал 2: Детектор аномалий
python -m ndtp_ids.anomaly_detector --interval 30

# Терминал 3: Веб-интерфейс
python -m ndtp_ids.web_interface --port 5000
```

### 2. Фаза обучения

Система автоматически начнет собирать baseline для каждого обнаруженного хоста:
- Первые 100 наблюдений (по умолчанию) используются для обучения
- Вычисляются средние значения и стандартные отклонения
- После накопления достаточных данных хост переходит в режим детекции

### 3. Фаза детекции

После обучения система:
- Сравнивает текущие метрики с baseline
- Вычисляет z-score для отклонений
- Генерирует алерты при превышении порогов
- Адаптирует baseline через EWMA

### 4. Гибридная детекция

Система применяет два метода одновременно:
1. **Сигнатурный** - проверка по правилам Suricata
2. **Поведенческий** - анализ отклонений от baseline

## Обучение системы

### Как начать обучение

1. **Автоматический режим** (рекомендуется)
   - Запустите систему в нормальной сети
   - Система автоматически обучится на первых 100 наблюдениях
   - Проверьте статус через веб-интерфейс `/training`

2. **Ручное управление**
   ```python
   from ndtp_ids.adaptive_trainer import AdaptiveTrainer
   
   trainer = AdaptiveTrainer()
   
   # Перевести хост в режим обучения
   trainer.set_learning_mode('192.168.1.100', enabled=True)
   
   # Сбросить профиль и начать заново
   trainer.reset_profile('192.168.1.100')
   ```

3. **Через веб-интерфейс**
   - Откройте `/training`
   - Выберите хост
   - Используйте кнопки управления

### Рекомендации по обучению

1. **Чистая сеть** - обучайте только на нормальном трафике
2. **Достаточно данных** - минимум 50-100 наблюдений
3. **Разное время** - включайте разные периоды дня
4. **Проверка** - мониторьте качество baseline

## Сравнение с Suricata

| Критерий | Suricata | NDTP IDS |
|----------|----------|----------|
| Сигнатурный анализ | ✅ Отлично | ✅ Базовый |
| Поведенческий анализ | ❌ Нет | ✅ Да |
| Адаптация к сети | ❌ Нет | ✅ Да |
| Объяснимость | ⚠️ Ограничена | ✅ Полная |
| Работа с TLS | ⚠️ Ограничена | ✅ Метаданные |
| Простота настройки | ❌ Сложно | ✅ Просто |
| Zero-day обнаружение | ❌ Нет | ✅ Да |
| Веб-интерфейс | ❌ Нет | ✅ Да |

## Безопасность

### Защита логов
- База данных SQLite с транзакциями
- Append-only режим для алертов
- Возможность добавления хеширования

### Защита от DoS
- Rate limiting (можно добавить)
- Ограничение размера базы данных
- Fail-open режим

### Приватность
- Не сохраняется payload пакетов
- Только метаданные (IP, порты, размеры)
- Соответствие GDPR

## Производительность

- **Коллектор**: до 10,000 пакетов/сек
- **Агрегатор**: обработка в реальном времени
- **Детектор**: проверка каждые 30-60 сек
- **Веб-интерфейс**: до 100 одновременных пользователей

## Расширение

### Добавление своих правил Suricata

```python
# Через API
POST /api/suricata/rules
{
    "rule": "alert tcp any any -> any 8080 (msg:\"Custom Rule\"; sid:2000001;)"
}

# Через файл
parser.load_rules_from_file("my_rules.rules")
```

### Настройка параметров обучения

```python
trainer = AdaptiveTrainer(
    learning_window=200,      # Больше наблюдений для обучения
    ewma_alpha=0.05,          # Медленная адаптация
    sliding_window_size=100   # Больший контекст
)
```

## Известные ограничения

1. **Базовый парсер Suricata** - поддерживаются не все операторы
2. **SQLite** - не для high-load окружений
3. **Один сервер** - нет распределенного режима
4. **Без WebSocket** - polling вместо push-уведомлений

## Дальнейшее развитие

- [ ] Полная поддержка Suricata синтаксиса
- [ ] WebSocket для real-time мониторинга
- [ ] Машинное обучение (Random Forest, Isolation Forest)
- [ ] Интеграция с SIEM системами
- [ ] Автоматическая блокировка (IPS режим)
- [ ] Поддержка PostgreSQL
- [ ] Кластерный режим

## Поддержка

Для вопросов и предложений создавайте issue в репозитории.
