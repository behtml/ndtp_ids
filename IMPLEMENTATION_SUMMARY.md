# Реализация требований из "Проекты ндтп.txt"

## Выполненные задачи

### ✅ 1. Интерфейс через библиотеку (Flask)

**Требование:** "сделай интерфейс через библиотеку которая написана в txt файле"

**Реализация:**
- Создан полноценный веб-интерфейс на Flask
- 6 страниц: Dashboard, Мониторинг, Хосты, Алерты, Правила, Обучение
- REST API для всех операций
- Визуализация в реальном времени

**Файлы:**
- `src/ndtp_ids/web_interface.py` - основное Flask приложение
- `src/ndtp_ids/templates/` - HTML шаблоны

### ✅ 2. Правила Suricata (сигнатурный анализ)

**Требование:** "на базе правил сурикаты"

**Реализация:**
- Полноценный парсер правил Suricata
- Поддержка базового синтаксиса (action, protocol, IP, ports, options)
- 10+ базовых правил из коробки
- Возможность добавления своих правил

**Файлы:**
- `src/ndtp_ids/suricata_rules.py`

**Пример правил:**
```
alert tcp any any -> any 22 (msg:"SSH Connection Attempt"; sid:1000001;)
alert tcp any any -> any 3389 (msg:"RDP Connection Attempt"; sid:1000007;)
alert tcp any any -> any [1-1024] (msg:"Connection to Privileged Port"; sid:1000003;)
```

### ✅ 3. Поведенческий анализ

**Требование:** "совмещать с поведенческим анализем"

**Реализация:**
- Z-score метод для детекции аномалий
- Профилирование каждого хоста
- Отслеживание 5 ключевых метрик:
  - Количество соединений
  - Уникальные порты
  - Уникальные IP назначения
  - Объем данных
  - Средний размер пакета

**Файлы:**
- `src/ndtp_ids/anomaly_detector.py` (улучшен)
- `src/ndtp_ids/aggregator.py` (используется)

**Гибридная детекция:**
```
Suricata правила → Известные атаки
       +
Поведенческий → Zero-day, аномалии
       =
Полная защита
```

### ✅ 4. Режим обучения

**Требование:** "посмотри последнюю часть txt файла там все написано и как начать обучать"

**Реализация согласно документу:**

#### 4.1 Автоматическое обучение baseline
- Сбор первых N наблюдений (по умолчанию 100)
- Вычисление mean и std для каждой метрики
- Автоматический переход в режим детекции

#### 4.2 Экспоненциальное сглаживание (EWMA)
```python
mean_new = α × current + (1-α) × mean_old
```
- Коэффициент α = 0.1 (настраиваемый)
- Плавная адаптация к изменениям

#### 4.3 Скользящее окно
- Пересчет baseline по последним N наблюдениям
- Учет временной динамики (день/ночь, будни/выходные)

#### 4.4 Защита от обучения на атаках
- Аномальные наблюдения НЕ включаются в baseline
- Предотвращение "отравления" модели

**Файлы:**
- `src/ndtp_ids/adaptive_trainer.py`

## Преимущества над Suricata (из документа)

Согласно разделу "Что можно сделать лучше суриката":

### 1. ✅ Объяснимость решений (Explainability Security)
**Suricata:** "SID 2010935"  
**NDTP IDS:** "Хост установил в 5 раз больше соединений (50 вместо 10). Z-score: 4.2"

### 2. ✅ Адаптивная модель под конкретную сеть
**Suricata:** Универсальные правила  
**NDTP IDS:** Индивидуальный профиль для каждого хоста

### 3. ✅ Работа с шифрованным трафиком
**Suricata:** DPI не работает с TLS  
**NDTP IDS:** Анализ метаданных (частота, направление, объемы)

### 4. ✅ Противодействие обходу сигнатур
**Suricata:** Сигнатурный полиморфизм  
**NDTP IDS:** Поведенческий слой - поведение не меняется

### 5. ✅ Корреляция во времени
**Suricata:** События изолированы  
**NDTP IDS:** История устройства, эскалация, частота

### 6. ✅ Минимизация утечки данных
**Suricata:** Анализирует payload  
**NDTP IDS:** Только метаданные

### 7. ✅ Контроль доверия к алерту
**Suricata:** Просто alert  
**NDTP IDS:** Confidence score, z-score, объяснение

### 8. ✅ Защищённость самой системы
- Защита от DoS на IDS (rate limiting возможен)
- Защита логов (SQLite transactions)
- Fail-safe режим

## Архитектура решения

```
┌─────────────┐
│   Packet    │  
│ Collector   │ ← Scapy: Захват метаданных
└──────┬──────┘
       │
       ├──────────┐
       │          v
       │    ┌──────────────┐
       │    │  Suricata    │ ← Сигнатурный анализ
       │    │    Rules     │   (известные атаки)
       │    └──────────────┘
       │
       v
┌──────────────┐
│ Aggregator   │ ← Временные окна, метрики
└──────┬───────┘
       │
       v
┌──────────────┐
│  Adaptive    │ ← EWMA, скользящее окно
│   Trainer    │   Защита от аномалий
└──────┬───────┘
       │
       v
┌──────────────┐
│  Anomaly     │ ← Z-score детекция
│  Detector    │   (аномалии, zero-day)
└──────┬───────┘
       │
       v
┌──────────────┐
│     Web      │ ← Flask Dashboard
│  Interface   │   API, визуализация
└──────────────┘
```

## Использование

### Быстрый старт

```bash
# 1. Демонстрация всех возможностей
python examples/integrated_demo.py

# 2. Запуск веб-интерфейса
python -m ndtp_ids.web_interface --port 5000
# Откройте http://localhost:5000

# 3. Полная система (3 терминала)
# T1: python -m ndtp_ids.packet_collector | python -m ndtp_ids.aggregator
# T2: python -m ndtp_ids.anomaly_detector
# T3: python -m ndtp_ids.web_interface
```

### Обучение системы

**Автоматический режим (рекомендуется):**
```bash
# Просто запустите систему - обучение автоматическое
python -m ndtp_ids.web_interface
```

**Ручное управление:**
```python
from ndtp_ids.adaptive_trainer import AdaptiveTrainer

trainer = AdaptiveTrainer()

# Перевести хост в обучение
trainer.set_learning_mode('192.168.1.100', enabled=True)

# Проверить статус
profile = trainer.get_host_profile('192.168.1.100')
print(f"Режим: {'Обучение' if profile.is_learning else 'Детекция'}")
```

## Созданные файлы

### Основные модули
1. `src/ndtp_ids/web_interface.py` - Flask веб-интерфейс (390 строк)
2. `src/ndtp_ids/suricata_rules.py` - Парсер правил Suricata (260 строк)
3. `src/ndtp_ids/adaptive_trainer.py` - Адаптивное обучение (480 строк)

### HTML шаблоны
4. `src/ndtp_ids/templates/dashboard.html` - Главная страница
5. `src/ndtp_ids/templates/hosts.html` - Список хостов
6. `src/ndtp_ids/templates/alerts.html` - История алертов
7. `src/ndtp_ids/templates/rules.html` - Правила Suricata
8. `src/ndtp_ids/templates/training.html` - Управление обучением
9. `src/ndtp_ids/templates/monitoring.html` - Live мониторинг

### Документация
10. `WEB_INTERFACE_GUIDE.md` - Подробное руководство (370 строк)
11. `TRAINING_QUICKSTART.md` - Быстрый старт и обучение (360 строк)
12. `README.md` - Обновлен с новыми возможностями

### Примеры
13. `examples/integrated_demo.py` - Полная демонстрация (340 строк)

## Технические детали

### Зависимости
```
scapy>=2.5.0  # Было уже
flask>=3.0.0  # Добавлено
```

### База данных (расширена)
- `host_profiles` - профили хостов с адаптивными метриками
- `metrics_history` - история для скользящего окна
- `training_config` - конфигурация обучения

### API Endpoints
- `GET /api/stats` - Общая статистика
- `GET /api/alerts` - Список алертов
- `GET /api/hosts` - Список хостов
- `GET /api/host/<ip>` - Детали хоста
- `POST /api/host/<ip>/learning` - Управление обучением
- `POST /api/host/<ip>/reset` - Сброс профиля
- `GET /api/suricata/rules` - Список правил
- `POST /api/suricata/rules` - Добавление правила

## Соответствие требованиям из документа

| Требование | Статус | Комментарий |
|-----------|--------|-------------|
| Интерфейс через библиотеку (Flask) | ✅ | Полноценный веб-интерфейс |
| Правила Suricata | ✅ | Парсер + 10 базовых правил |
| Поведенческий анализ | ✅ | Z-score + профилирование |
| Режим обучения | ✅ | EWMA + скользящее окно |
| Защита от обучения на атаках | ✅ | Реализовано |
| Адаптивные пороги | ✅ | Динамическое обновление |
| Объяснимость решений | ✅ | Детальное описание алертов |
| Гибридная детекция | ✅ | Suricata + Behavioral |

## Результат

✅ Полностью реализованы все требования из документа "Проекты ндтп.txt":
- Веб-интерфейс на Flask
- Интеграция правил Suricata (сигнатурный анализ)
- Поведенческий анализ (z-score)
- Режим обучения с EWMA и защитой от аномалий
- Гибридная система детекции
- Улучшения над Suricata (объяснимость, адаптивность, работа с TLS)

✅ Дополнительно:
- Подробная документация (2 руководства)
- Интегрированное демо
- REST API
- Профилирование хостов
- Визуализация в реальном времени

## Дальнейшее развитие

Возможные улучшения:
- [ ] WebSocket для real-time обновлений
- [ ] Полная поддержка синтаксиса Suricata
- [ ] IPS режим (автоблокировка)
- [ ] Machine Learning модели
- [ ] Интеграция с внешними SIEM
- [ ] Поддержка PostgreSQL
- [ ] Кластерный режим

---

**Создано:** 2026-02-12  
**На основе:** "Проекты ндтп - Практико-ориентированные проекты ИБ.txt"  
**Репозиторий:** https://github.com/behtml/ndtp_ids
